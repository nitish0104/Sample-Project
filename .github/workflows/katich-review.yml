name: Katich AI Code Review with Live HTML

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - master

# Allow workflow to create deployment
permissions:
  contents: write      # For committing HTML to gh-pages
  pages: write         # For deploying to GitHub Pages
  id-token: write      # For OIDC token
  pull-requests: write # For posting comments
  actions: read        # For workflow links

jobs:
  review-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Fetch PR head branch
        run: |
          git fetch origin ${{ github.event.pull_request.head.ref }}
      
      - name: Install Katich
        run: |
          curl -L https://github.com/kodehash/katichai-dist/releases/latest/download/katich_linux_amd64.tar.gz -o katich.tar.gz
          tar -xzf katich.tar.gz
          chmod +x katich-linux-amd64
          sudo mv katich-linux-amd64 /usr/local/bin/katich
      
      - name: Configure Katich
        env:
          KATICH_LLM_API_KEY: ${{ secrets.KATICH_LLM_API_KEY }}
        run: |
          katich init
          cat > .katich/config.yaml << EOF
          project_name: ${{ github.repository }}
          llm:
            provider: openai
            model: gpt-4o
          embeddings:
            provider: openai
          review:
            generate_html: true
            html_output_path: ./katich-report
          EOF
      
      - name: Run Katich Review
        id: run-review
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="origin/${{ github.event.pull_request.head.ref }}"
          
          echo "ü§ñ Running review: $BASE_BRANCH..$HEAD_BRANCH"
          
          # Run review and capture output
          katich review diff "$BASE_BRANCH".."$HEAD_BRANCH" 2>&1 | \
            sed -u 's/\x1b\[[0-9;]*m//g' | tee review_output.txt
          
          # Generate JSON for processing
          katich review diff "$BASE_BRANCH".."$HEAD_BRANCH" \
            --output json --output-file review.json 2>/dev/null || true
      
      - name: Prepare HTML Report for Pages
        id: prepare-report
        run: |
          # Find the generated HTML report
          HTML_REPORT=$(find ./katich-report -name "*.html" -type f | head -1)
          
          if [ -f "$HTML_REPORT" ]; then
            echo "üìÑ Found HTML report: $HTML_REPORT"
            
            # Create a unique directory for this PR report
            PR_NUMBER="${{ github.event.pull_request.number }}"
            RUN_ID="${{ github.run_id }}"
            REPORT_DIR="reports/PR-$PR_NUMBER-$RUN_ID"
            
            # Create directory structure
            mkdir -p "./pages-deploy/$REPORT_DIR"
            
            # Copy and rename the HTML report
            cp "$HTML_REPORT" "./pages-deploy/$REPORT_DIR/index.html"
            
            # Copy any supporting files (CSS, JS, images)
            find ./katich-report -type f \( -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.svg" \) \
              -exec cp {} "./pages-deploy/$REPORT_DIR/" \;
            
            # Create a landing page with all PR reports
            cat > "./pages-deploy/index.html" << EOF
            <!DOCTYPE html>
            <html>
            <head>
              <title>Katich AI Review Reports</title>
              <style>
                body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
                .report { border: 1px solid #e1e4e8; border-radius: 6px; padding: 20px; margin: 20px 0; }
                .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-right: 8px; }
                .badge.pr { background: #0969da; color: white; }
                .badge.date { background: #f6f8fa; color: #57606a; }
                a { color: #0969da; text-decoration: none; }
                a:hover { text-decoration: underline; }
                h1 { border-bottom: 1px solid #e1e4e8; padding-bottom: 10px; }
              </style>
            </head>
            <body>
              <h1>üìä Katich AI Review Reports</h1>
              <p>Interactive code review reports for your pull requests.</p>
              
              <div class="report">
                <h3>
                  <a href="$REPORT_DIR/index.html">PR #$PR_NUMBER Review</a>
                </h3>
                <div style="margin: 10px 0;">
                  <span class="badge pr">PR #$PR_NUMBER</span>
                  <span class="badge date">$(date +'%Y-%m-%d %H:%M')</span>
                  <span class="badge date">Run: $RUN_ID</span>
                </div>
                <p><strong>Repository:</strong> ${{ github.repository }}</p>
                <p><strong>Base:</strong> ${{ github.event.pull_request.base.ref }}</p>
                <p><strong>Head:</strong> ${{ github.event.pull_request.head.ref }}</p>
                <a href="$REPORT_DIR/index.html" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #0969da; color: white; border-radius: 6px;">
                  üîç View Interactive Report
                </a>
              </div>
              
              <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e1e4e8; color: #57606a; font-size: 14px;">
                <p>ü§ñ Generated by <a href="https://github.com/kodehash/katichai-dist">Katich AI</a></p>
                <p>Reports auto-delete after PR closure</p>
              </footer>
            </body>
            </html>
            EOF
            
            # Set outputs for later use
            echo "report_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$REPORT_DIR/index.html" >> $GITHUB_OUTPUT
            echo "landing_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
            echo "report_dir=$REPORT_DIR" >> $GITHUB_OUTPUT
            echo "has_report=true" >> $GITHUB_OUTPUT
            
            echo "‚úÖ HTML report prepared for Pages deployment"
            echo "üìé Report will be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$REPORT_DIR/"
          else
            echo "‚ùå No HTML report found"
            echo "has_report=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v2
        if: steps.prepare-report.outputs.has_report == 'true'
        with:
          path: ./pages-deploy
      
      - name: Deploy to GitHub Pages
        id: deployment
        if: steps.prepare-report.outputs.has_report == 'true'
        uses: actions/deploy-pages@v3
      
      - name: Generate PR Comment with Live Link
        id: generate-comment
        run: |
          # Extract metrics from review
          CHANGED_FILES=$(git diff --name-only "${{ github.event.pull_request.base.ref }}".."origin/${{ github.event.pull_request.head.ref }}" | wc -l)
          
          if [ -f "review_output.txt" ]; then
            CRITICAL_COUNT=$(grep -c "üî¥" review_output.txt || echo "0")
            WARNING_COUNT=$(grep -c "üü°" review_output.txt || echo "0")
            TOKEN_USAGE=$(grep -o "Tokens:.*total" review_output.txt | head -1 || echo "N/A")
            
            # Get summary
            SUMMARY_LINE=$(grep -A 2 "SUMMARY" review_output.txt | tail -1)
            if [ -n "$SUMMARY_LINE" ]; then
              SUMMARY="$SUMMARY_LINE"
            else
              SUMMARY="AI code review completed. Click the link below for interactive results."
            fi
          else
            CRITICAL_COUNT="0"
            WARNING_COUNT="0"
            TOKEN_USAGE="N/A"
            SUMMARY="Interactive code review completed."
          fi
          
          # Create comment with LIVE HTML LINK
          cat > pr_comment.md << EOF
          ## üéØ Katich AI Live Code Review
          
          ### üöÄ **Live Interactive Report Available!**
          
          **[üîç CLICK HERE TO VIEW INTERACTIVE HTML REPORT](${{ steps.prepare-report.outputs.report_url }})**
          
          *No download needed - opens directly in browser*
          
          ---
          
          ### üìä Quick Stats
          
          | Metric | Value |
          |--------|-------|
          | **üìù Changed Files** | \`$CHANGED_FILES\` |
          | **üî¥ Critical Issues** | \`$CRITICAL_COUNT\` |
          | **üü° Warnings** | \`$WARNING_COUNT\` |
          | **üí∞ Token Usage** | \`$TOKEN_USAGE\` |
          | **üåê Live Report** | **[View Now](${{ steps.prepare-report.outputs.report_url }})** |
          
          ---
          
          ### üìù Executive Summary
          
          $SUMMARY
          
          ---
          
          ### üé® **Interactive Features Available:**
          
          ‚úÖ **Live Dashboard** - Real-time metrics  
          ‚úÖ **Clickable Navigation** - Jump to any file  
          ‚úÖ **Syntax Highlighting** - Color-coded code  
          ‚úÖ **Search & Filter** - Find specific issues  
          ‚úÖ **Side-by-side Diffs** - Compare changes  
          ‚úÖ **No Download Required** - Works in browser  
          
          ---
          
          ### üîó Quick Links
          
          - **[üìä Interactive HTML Report](${{ steps.prepare-report.outputs.report_url }})** - *Main Report*
          - **[üè† All Reports Dashboard](${{ steps.prepare-report.outputs.landing_url }})** - *All PR Reports*
          - **[üìã Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})** - *Debug info*
          - **[#Ô∏è‚É£ PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})** - *Back to PR*
          
          ---
          
          ### ‚öôÔ∏è Technical Details
          
          <details>
          <summary>üîç Click for configuration details</summary>
          
          | Setting | Value |
          |---------|-------|
          | **Base Branch** | \`${{ github.event.pull_request.base.ref }}\` |
          | **Head Branch** | \`${{ github.event.pull_request.head.ref }}\` |
          | **Report URL** | [${{ steps.prepare-report.outputs.report_url }}](${{ steps.prepare-report.outputs.report_url }}) |
          | **Deployment Status** | ${{ steps.deployment.outputs.page_url && '‚úÖ Live' || '‚è≥ Deploying...' }} |
          | **Auto-Cleanup** | ‚úÖ Yes (on PR close) |
          
          </details>
          
          ---
          
          <div align="center">
          
          **ü§ñ Powered by [Katich AI](https://github.com/kodehash/katichai-dist)**  
          üåê *Live report deployed to GitHub Pages*
          
          </div>
          EOF
          
          echo "‚úÖ PR comment with live link generated"
      
      - name: Post Comment with Live Link
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let commentBody = fs.readFileSync('pr_comment.md', 'utf8');
            
            // Clean any stray ANSI codes
            commentBody = commentBody.replace(/\x1b\[[0-9;]*m/g, '');
            
            try {
              // Find existing Katich comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const katichComment = comments.find(comment => 
                comment.body.includes('Katich AI Live Code Review') || 
                comment.body.includes('Live Interactive Report')
              );
              
              if (katichComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: katichComment.id,
                  body: commentBody
                });
                console.log('‚úÖ Updated existing Katich comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('‚úÖ Posted new Katich comment with live link');
              }
            } catch (error) {
              console.error('‚ùå Failed to post comment:', error.message);
            }
      
      - name: Create Auto-Cleanup Marker
        if: steps.prepare-report.outputs.has_report == 'true'
        run: |
          # Create a cleanup marker file for this PR
          PR_NUMBER="${{ github.event.pull_request.number }}"
          RUN_ID="${{ github.run_id }}"
          
          cat > cleanup-marker.json << EOF
          {
            "pr_number": $PR_NUMBER,
            "run_id": "$RUN_ID",
            "report_dir": "${{ steps.prepare-report.outputs.report_dir }}",
            "repository": "${{ github.repository }}",
            "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "pages_url": "${{ steps.prepare-report.outputs.report_url }}"
          }
          EOF
          
          # Upload as artifact for cleanup workflow
          mkdir -p cleanup-markers
          cp cleanup-marker.json "cleanup-markers/PR-$PR_NUMBER-$RUN_ID.json"
          
          echo "‚úÖ Cleanup marker created for auto-deletion"
      
      - name: Upload Cleanup Markers
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-markers
          path: cleanup-markers/
          retention-days: 1
