name: Katich AI Advanced Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Type of review'
        required: false
        default: 'diff'
        type: choice
        options:
          - diff
          - full
          - latest

jobs:
  katich-advanced-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref || github.ref_name }}
          fetch-depth: 0
      
      - name: Debug Git Information
        run: |
          echo "üìä Git Repository Information:"
          echo "Current branch: $(git branch --show-current)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "All branches:"
          git branch -a
          echo ""
          echo "Recent commits:"
          git log --oneline -10
      
      - name: Cache Katich binary
        uses: actions/cache@v4
        id: cache-katich
        with:
          path: /usr/local/bin/katich
          key: katich-${{ runner.os }}-latest
      
      - name: Download and Install Katich
        if: steps.cache-katich.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/kodehash/katichai-dist/releases/latest/download/katich_linux_amd64.tar.gz -o katich.tar.gz
          tar -xzf katich.tar.gz
          chmod +x katich-linux-amd64
          sudo mv katich-linux-amd64 /usr/local/bin/katich
      
      - name: Verify Katich Installation
        run: |
          echo "üîç Verifying Katich installation..."
          katich version
          echo ""
          echo "üè• Running diagnostics..."
          katich doctor || true
      
      - name: Initialize Katich
        run: |
          echo "üöÄ Initializing Katich..."
          katich init
          echo "‚úÖ Katich initialized"
          ls -la .katich/
      
      - name: Configure Katich with Enhanced Settings
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ ! -z "$OPENAI_API_KEY" ]; then
            PROVIDER="openai"
            MODEL="gpt-4"
            API_KEY="$OPENAI_API_KEY"
            echo "‚úÖ Using OpenAI provider"
          elif [ ! -z "$ANTHROPIC_API_KEY" ]; then
            PROVIDER="anthropic"
            MODEL="claude-3-5-sonnet-20241022"
            API_KEY="$ANTHROPIC_API_KEY"
            echo "‚úÖ Using Anthropic provider"
          else
            echo "‚ùå No API key configured"
            echo "::error::Please set OPENAI_API_KEY or ANTHROPIC_API_KEY in GitHub Secrets"
            exit 1
          fi
          
          cat > .katich/config.yaml << EOF
          project_name: ${{ github.repository }}
          
          llm:
            provider: $PROVIDER
            model: $MODEL
            api_key: "$API_KEY"
            max_input_tokens: 30000
          
          embeddings:
            provider: openai
            model: text-embedding-3-small
          
          review:
            generate_html: true
            html_output_path: .katich/reports
          
          analysis:
            max_function_length: 50
            complexity_threshold: 10
            similarity_threshold: 0.70
            min_function_lines: 5
            duplicate_threshold: 0.85
            ignore_trivial_patterns: true
            sampling:
              enabled: true
              max_files: 100
              context_lines: 3
              skip_generated: true
              skip_tests: false
              adaptive_budget: true
          EOF
          
          echo "‚úÖ Configuration created successfully"
      
      - name: Fetch PR Head Branch
        if: github.event_name == 'pull_request'
        run: |
          echo "üîÑ Fetching PR head branch..."
          git fetch origin ${{ github.event.pull_request.head.ref }}
          echo "‚úÖ Head branch fetched"
          
          echo "üìä Available refs:"
          git show-ref | grep -E "(heads|remotes)" || true
      
      - name: Cache Context Data
        uses: actions/cache@v4
        with:
          path: |
            .katich/context.json
            .katich/embeddings.json
          key: katich-context-${{ github.sha }}
          restore-keys: |
            katich-context-
      
      - name: Build Context (Optional)
        continue-on-error: true
        run: |
          if [ -f ".katich/context.json" ]; then
            echo "‚úÖ Using cached context"
          else
            echo "üîç Building fresh context (this may take a while)..."
            timeout 300 katich context build || echo "‚ö†Ô∏è Context build timeout or failed, continuing without context"
          fi
      
      - name: Determine Review Parameters
        id: review-params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REVIEW_TYPE="${{ inputs.review_type }}"
          else
            REVIEW_TYPE="diff"
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            HEAD_REF="origin/${{ github.event.pull_request.head.ref }}"
          else
            BASE_REF="${{ github.ref_name }}"
            HEAD_REF="HEAD"
          fi
          
          echo "review_type=$REVIEW_TYPE" >> $GITHUB_OUTPUT
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          
          echo "üìä Review Parameters:"
          echo "  Type: $REVIEW_TYPE"
          echo "  Base: $BASE_REF"
          echo "  Head: $HEAD_REF"
      
      - name: Verify Branches Exist
        if: steps.review-params.outputs.review_type == 'diff'
        run: |
          BASE="${{ steps.review-params.outputs.base_ref }}"
          HEAD="${{ steps.review-params.outputs.head_ref }}"
          
          echo "üîç Verifying branches..."
          
          # Check if base exists
          if git rev-parse "$BASE" >/dev/null 2>&1; then
            echo "‚úÖ Base branch exists: $BASE"
            git log -1 "$BASE"
          else
            echo "‚ùå Base branch not found: $BASE"
            echo "Available branches:"
            git branch -a
            exit 1
          fi
          
          # Check if head exists
          if git rev-parse "$HEAD" >/dev/null 2>&1; then
            echo "‚úÖ Head branch exists: $HEAD"
            git log -1 "$HEAD"
          else
            echo "‚ùå Head branch not found: $HEAD"
            echo "Available refs:"
            git show-ref
            exit 1
          fi
          
          # Check if there are differences
          DIFF_COUNT=$(git diff --name-only "$BASE".."$HEAD" | wc -l)
          echo ""
          echo "üìä Changes detected: $DIFF_COUNT files"
          
          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No changes detected between branches"
            echo "This might indicate the branches are identical"
          else
            echo "üìù Changed files:"
            git diff --name-only "$BASE".."$HEAD" | head -20
          fi
      
      - name: Run Katich Review
        id: katich-review
        continue-on-error: true
        run: |
          REVIEW_TYPE="${{ steps.review-params.outputs.review_type }}"
          BASE_REF="${{ steps.review-params.outputs.base_ref }}"
          HEAD_REF="${{ steps.review-params.outputs.head_ref }}"
          
          echo "ü§ñ Starting Katich Review..."
          echo "Review type: $REVIEW_TYPE"
          
          # Set up output file
          touch review_raw.txt
          
          case $REVIEW_TYPE in
            "diff")
              echo "üìä Running diff review: $BASE_REF..$HEAD_REF"
              katich review diff "$BASE_REF".."$HEAD_REF" 2>&1 | tee review_raw.txt
              EXIT_CODE=${PIPESTATUS[0]}
              ;;
            "full")
              echo "üìä Running full repository review"
              katich review full 2>&1 | tee review_raw.txt
              EXIT_CODE=${PIPESTATUS[0]}
              ;;
            "latest")
              echo "üìä Running latest commit review"
              katich review latest 2>&1 | tee review_raw.txt
              EXIT_CODE=${PIPESTATUS[0]}
              ;;
            *)
              echo "‚ùå Unknown review type: $REVIEW_TYPE"
              EXIT_CODE=1
              ;;
          esac
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Display output
          if [ -s review_raw.txt ]; then
            echo "‚úÖ Review output captured"
            cat review_raw.txt
          else
            echo "‚ö†Ô∏è No review output generated"
          fi
          
          # Check for reports
          if [ -d ".katich/reports" ] && [ "$(ls -A .katich/reports 2>/dev/null)" ]; then
            echo "‚úÖ Reports generated:"
            ls -lh .katich/reports/
          else
            echo "‚ö†Ô∏è No reports found in .katich/reports"
          fi
          
          exit $EXIT_CODE
      
      - name: Handle Review Failure
        if: steps.katich-review.outputs.exit_code != '0'
        run: |
          echo "‚ö†Ô∏è Katich review encountered an error"
          echo "Exit code: ${{ steps.katich-review.outputs.exit_code }}"
          
          # Check for common issues
          if grep -q "API key" review_raw.txt 2>/dev/null; then
            echo "::error::API key issue detected. Please verify your API key is correct and has sufficient credits."
          elif grep -q "not found\|does not exist" review_raw.txt 2>/dev/null; then
            echo "::error::Branch or file not found. Check that the branches exist."
          elif grep -q "timeout\|connection" review_raw.txt 2>/dev/null; then
            echo "::error::Network or timeout issue. The API provider might be unavailable."
          fi
          
          # Create a basic error report
          cat > review.md << 'EOF'
          ## ‚ö†Ô∏è Review Error
          
          The Katich AI review encountered an error during execution.
          
          **Please check:**
          - API key is valid and has credits
          - Network connectivity to API provider
          - Branch references are correct
          - Repository has commits to review
          
          See the workflow logs for detailed error information.
          EOF
      
      - name: Parse Review Results
        if: steps.katich-review.outputs.exit_code == '0'
        id: parse-results
        run: |
          # Create formatted review if raw output exists
          if [ -s review_raw.txt ]; then
            cp review_raw.txt review.md
          else
            echo "No review content" > review.md
          fi
          
          # Count issues
          CRITICAL=$(grep -c "üî¥" review.md 2>/dev/null || echo "0")
          WARNING=$(grep -c "üü°" review.md 2>/dev/null || echo "0")
          SECURITY=$(grep -c "\[SECURITY\]" review.md 2>/dev/null || echo "0")
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "warning=$WARNING" >> $GITHUB_OUTPUT
          echo "security=$SECURITY" >> $GITHUB_OUTPUT
          
          echo "üìä Review Statistics:"
          echo "  üî¥ Critical: $CRITICAL"
          echo "  üü° Warnings: $WARNING"
          echo "  üõ°Ô∏è Security: $SECURITY"
      
      - name: Generate PR Comment
        if: always()
        run: |
          if [ "${{ steps.katich-review.outputs.exit_code }}" = "0" ]; then
            cat > pr_comment.md << 'EOF'
          ## ü§ñ Katich AI Code Review Results
          
          ### üìä Summary
          - üî¥ **Critical Issues**: ${{ steps.parse-results.outputs.critical || '0' }}
          - üü° **Warnings**: ${{ steps.parse-results.outputs.warning || '0' }}
          - üõ°Ô∏è **Security Issues**: ${{ steps.parse-results.outputs.security || '0' }}
          
          ### üìù Detailed Review
          EOF
            
            if [ -f "review.md" ]; then
              cat review.md >> pr_comment.md
            fi
          else
            cat > pr_comment.md << 'EOF'
          ## ‚ö†Ô∏è Katich AI Review Error
          
          The automated code review encountered an error and could not complete.
          
          **Common issues:**
          - Invalid or expired API key
          - Insufficient API credits
          - Network connectivity problems
          - No changes detected between branches
          
          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          
          You can also run the review manually:
          ```bash
          katich review diff ${{ steps.review-params.outputs.base_ref }}..${{ steps.review-params.outputs.head_ref }}
          ```
          EOF
          fi
          
          cat >> pr_comment.md << 'EOF'
          
          ---
          
          <details>
          <summary>‚ÑπÔ∏è Review Information</summary>
          
          - **Review Type**: ${{ steps.review-params.outputs.review_type }}
          - **Base Branch**: ${{ steps.review-params.outputs.base_ref }}
          - **Head Branch**: ${{ steps.review-params.outputs.head_ref }}
          - **Commit**: `${{ github.sha }}`
          - **Status**: ${{ steps.katich-review.outputs.exit_code == '0' && '‚úÖ Success' || '‚ùå Failed' }}
          
          *Generated by [Katich AI](https://github.com/kodehash/katichai-dist)*
          </details>
          EOF
      
      - name: Post/Update PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('pr_comment.md', 'utf8');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.body.includes('ü§ñ Katich AI Code Review Results') ||
              comment.body.includes('‚ö†Ô∏è Katich AI Review Error')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('‚úÖ Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('‚úÖ Created new comment');
            }
      
      - name: Upload Reports and Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katich-review-output-${{ github.sha }}
          path: |
            .katich/reports/**/*
            review.md
            review_raw.txt
            pr_comment.md
            .katich/config.yaml
          retention-days: 90
          if-no-files-found: warn
      
      - name: Summary
        if: always()
        run: |
          echo "## üéØ Katich Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.katich-review.outputs.exit_code }}" = "0" ]; then
            echo "### ‚úÖ Review Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- üî¥ Critical Issues: ${{ steps.parse-results.outputs.critical || '0' }}" >> $GITHUB_STEP_SUMMARY
            echo "- üü° Warnings: ${{ steps.parse-results.outputs.warning || '0' }}" >> $GITHUB_STEP_SUMMARY
            echo "- üõ°Ô∏è Security Issues: ${{ steps.parse-results.outputs.security || '0' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Review Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Exit Code:** ${{ steps.katich-review.outputs.exit_code }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Review Type: ${{ steps.review-params.outputs.review_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Base: ${{ steps.review-params.outputs.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Head: ${{ steps.review-params.outputs.head_ref }}" >> $GITHUB_STEP_SUMMARY
