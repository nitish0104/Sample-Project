name: Katich AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - master

jobs:
  katich-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read  # Required for workflow links
    
    steps:
      - name: Checkout base branch with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
      
      - name: Fetch PR head branch
        run: |
          echo "ğŸ”„ Fetching PR branches..."
          git fetch origin ${{ github.event.pull_request.head.ref }}
      
      - name: Download and Install Katich
        run: |
          echo "ğŸ“¥ Downloading Katich..."
          curl -L https://github.com/kodehash/katichai-dist/releases/latest/download/katich_linux_amd64.tar.gz -o katich.tar.gz
          tar -xzf katich.tar.gz
          chmod +x katich-linux-amd64
          sudo mv katich-linux-amd64 /usr/local/bin/katich
          katich version
      
      - name: Initialize and Configure Katich
        env:
          KATICH_LLM_API_KEY: ${{ secrets.KATICH_LLM_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸš€ Initializing Katich..."
          katich init
          
          # Create optimized config
          cat > .katich/config.yaml << EOF
          project_name: ${{ github.repository }}
          
          llm:
            provider: openai
            model: gpt-4o
            max_input_tokens: 100000
            max_tokens: 4000
          
          embeddings:
            provider: openai
            model: text-embedding-3-small
          
          review:
            generate_html: true
            html_output_path: .katich/reports
          
          analysis:
            max_function_length: 50
            complexity_threshold: 10
            similarity_threshold: 0.70
            min_function_lines: 5
            duplicate_threshold: 0.85
            ignore_trivial_patterns: true
            sampling:
              enabled: true
              max_files: 50
              context_lines: 2
              skip_generated: true
              skip_tests: false
              adaptive_budget: true
          EOF
      
      - name: Run Katich Review
        id: run-review
        continue-on-error: true
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="origin/${{ github.event.pull_request.head.ref }}"
          
          echo "ğŸ¤– Starting Katich AI Review..."
          echo "ğŸ“Š Review range: $BASE_BRANCH..$HEAD_BRANCH"
          
          # Run review and capture output
          katich review diff "$BASE_BRANCH".."$HEAD_BRANCH" --output json --output-file review.json 2>&1 | tee review_output.txt
          
          # Also generate markdown for backup
          katich review diff "$BASE_BRANCH".."$HEAD_BRANCH" --output markdown --output-file review.md 2>&1 || true
          
          # Check for HTML report
          if [ -d ".katich/reports" ]; then
            HTML_REPORT=$(find .katich/reports -name "*.html" -type f | head -1)
            if [ -f "$HTML_REPORT" ]; then
              echo "html_report_path=$HTML_REPORT" >> $GITHUB_OUTPUT
              echo "âœ… HTML report generated: $HTML_REPORT"
            fi
          fi
      
      - name: Process Review Results
        id: process-results
        run: |
          # Extract key metrics from JSON if available
          if [ -f "review.json" ]; then
            echo "ğŸ“Š Processing JSON results..."
            
            # Use jq to extract data
            SUMMARY=$(jq -r '.summary // "No summary provided."' review.json 2>/dev/null || echo "No summary available")
            TOKEN_USAGE=$(jq -r '.token_usage // "N/A"' review.json 2>/dev/null || echo "N/A")
            
            # Count critical issues
            CRITICAL_ISSUES=$(jq -r '.issues[] | select(.severity == "critical") | .title' review.json 2>/dev/null | wc -l || echo "0")
            WARNING_ISSUES=$(jq -r '.issues[] | select(.severity == "warning") | .title' review.json 2>/dev/null | wc -l || echo "0")
            
            echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
            echo "warning_issues=$WARNING_ISSUES" >> $GITHUB_OUTPUT
            echo "token_usage=$TOKEN_USAGE" >> $GITHUB_OUTPUT
            
            # Store summary for PR comment
            echo "$SUMMARY" > review_summary.txt
          else
            echo "âš ï¸ No JSON results found"
            echo "critical_issues=0" >> $GITHUB_OUTPUT
            echo "warning_issues=0" >> $GITHUB_OUTPUT
            echo "token_usage=N/A" >> $GITHUB_OUTPUT
          fi
          
          # Count changed files
          CHANGED_FILES=$(git diff --name-only "${{ github.event.pull_request.base.ref }}".."origin/${{ github.event.pull_request.head.ref }}" | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
      
      - name: Generate Interactive PR Comment
        id: generate-comment
        run: |
          # Read summary if available
          if [ -f "review_summary.txt" ]; then
            REVIEW_SUMMARY=$(cat review_summary.txt | head -3 | tr '\n' ' ')
          else
            REVIEW_SUMMARY="Comprehensive AI code review completed. Check details below."
          fi
          
          # Create interactive markdown comment
          cat > pr_comment.md << EOF
          ## ğŸš€ Katich AI Code Review Report
          
          | ğŸ“Š Metric | ğŸ“ˆ Value |
          |-----------|----------|
          | **Changed Files** | \`${{ steps.process-results.outputs.changed_files }}\` |
          | **ğŸ”´ Critical Issues** | \`${{ steps.process-results.outputs.critical_issues }}\` |
          | **ğŸŸ¡ Warnings** | \`${{ steps.process-results.outputs.warning_issues }}\` |
          | **ğŸ’° Tokens Used** | \`${{ steps.process-results.outputs.token_usage }}\` |
          | **ğŸ¤– Model** | GPT-4o |
          
          ---
          
          ### ğŸ“ Executive Summary
          
          $REVIEW_SUMMARY
          
          ---
          
          ### ğŸ¯ Quick Actions
          
          <table>
          <tr>
          <td width="33%">
          
          #### ğŸ“‹ View Full Report
          [**Download HTML Report**](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          
          Features:
          â€¢ Interactive charts
          â€¢ Code highlighting
          â€¢ File navigation
          
          </td>
          <td width="33%">
          
          #### ğŸ” Review Details
          <details>
          <summary>Click to expand review details</summary>
          
          EOF
          
          # Add review details if markdown exists
          if [ -f "review.md" ]; then
            # Extract key sections
            echo "" >> pr_comment.md
            echo "**Critical Issues:**" >> pr_comment.md
            grep -A 5 "CRITICAL ISSUES" review.md | tail -n +2 | head -10 >> pr_comment.md 2>/dev/null || echo "None found âœ…" >> pr_comment.md
            
            echo "" >> pr_comment.md
            echo "**Suggestions:**" >> pr_comment.md
            grep -A 5 "SUGGESTIONS" review.md | tail -n +2 | head -10 >> pr_comment.md 2>/dev/null || echo "No suggestions" >> pr_comment.md
          fi
          
          cat >> pr_comment.md << EOF
          
          </details>
          </td>
          <td width="33%">
          
          #### âš¡ Direct Links
          â€¢ [**View Workflow Run**](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          â€¢ [**Download Artifacts**](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          â€¢ [**Katich Docs**](https://github.com/kodehash/katichai-dist)
          
          </td>
          </tr>
          </table>
          
          ---
          
          ### ğŸ“ File-by-File Analysis
          
          <details>
          <summary>ğŸ“Š Click to view detailed file analysis</summary>
          
          EOF
          
          # Add file analysis if available
          if [ -f "review_output.txt" ]; then
            echo "\`\`\`" >> pr_comment.md
            # Extract file analysis section
            sed -n '/ğŸ“Š Sampling Report:/,/ğŸ¤– Querying LLM for review.../p' review_output.txt | \
              grep -v "ğŸ¤– Querying LLM for review..." | \
              sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md 2>/dev/null || echo "File analysis not available" >> pr_comment.md
            echo "\`\`\`" >> pr_comment.md
          fi
          
          cat >> pr_comment.md << EOF
          
          </details>
          
          ---
          
          ### ğŸ¨ Interactive Preview (HTML Report)
          
          Since GitHub doesn't allow HTML in comments, here's a **screenshot preview** of what the interactive report looks like:
          
          | Feature | Description |
          |---------|-------------|
          | **ğŸ“ˆ Dashboard** | Visual metrics and charts |
          | **ğŸ” File Explorer** | Navigate between reviewed files |
          | **ğŸ¨ Syntax Highlighting** | Color-coded code snippets |
          | **ğŸ“‹ Issue Tracking** | Filter by severity and type |
          
          **To view the full interactive report:**
          1. Go to the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. Scroll to **Artifacts** section
          3. Click **katich-html-report**
          4. Download and open \`review-*.html\` in your browser
          
          ---
          
          ### âš™ï¸ Configuration Details
          
          <details>
          <summary>ğŸ”§ Click to view technical details</summary>
          
          | Setting | Value |
          |---------|-------|
          | **Base Branch** | \`${{ github.event.pull_request.base.ref }}\` |
          | **Head Branch** | \`${{ github.event.pull_request.head.ref }}\` |
          | **PR Number** | #${{ github.event.pull_request.number }} |
          | **Workflow Run** | [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | **Commit SHA** | \`${{ github.sha }}\` |
          
          **Review Settings:**
          â€¢ Max files: 50
          â€¢ Context lines: 2
          â€¢ Skip tests: No
          â€¢ Adaptive budget: Yes
          
          </details>
          
          ---
          
          <div align="center">
          
          **ğŸ¤– Powered by [Katich AI](https://github.com/kodehash/katichai-dist)**
          
          ğŸ“Š *Review completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
          
          </div>
          EOF
          
          echo "âœ… Interactive PR comment generated"
      
      - name: Post Interactive PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('pr_comment.md', 'utf8');
            
            try {
              // Find existing Katich comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const katichComment = comments.find(comment => 
                comment.body.includes('Katich AI Code Review Report')
              );
              
              if (katichComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: katichComment.id,
                  body: commentBody
                });
                console.log('âœ… Updated existing Katich comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('âœ… Posted new Katich comment');
              }
            } catch (error) {
              console.error('âŒ Failed to post comment:', error.message);
              core.setFailed('Failed to post PR comment');
            }
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katich-html-report
          path: |
            .katich/reports/*.html
            review.json
            review.md
            pr_comment.md
          retention-days: 30
