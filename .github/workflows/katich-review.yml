name: Katich AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      # Primary configuration - choose ONE based on your provider
      KATICH_LLM_API_KEY: ${{ secrets.KATICH_LLM_API_KEY }}
      
      # Provider-specific (optional - only if your config.yaml specifies)
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      # API Server configuration (if using enterprise/centralized keys)
      KATICH_API_SERVER_URL: ${{ secrets.KATICH_API_SERVER_URL }}
      KATICH_API_TOKEN: ${{ secrets.KATICH_API_TOKEN }}
      
      # Optional: Override default configuration
      KATICH_MAX_INPUT_TOKENS: 20000
      KATICH_HTML_OUTPUT: "true"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Katich AI
        run: |
          curl -L https://github.com/kodehash/katichai-dist/releases/latest/download/katich_linux_amd64.tar.gz -o katich.tar.gz
          tar -xzf katich.tar.gz
          mv katich-linux-amd64 katich
          sudo mv katich /usr/local/bin/
          katich version

      - name: Initialize Katich with Environment Configuration
        run: |
          # Checkout base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git checkout ${{ github.event.pull_request.base.ref }}
          
          # Initialize katich
          katich init
          
          # OPTION 1: Use environment variables only (no config file modification)
          # Katich will automatically use the env vars we set above
          
          # OPTION 2: Create minimal config file
          cat > .katich/config.yaml << EOF
          project_name: ${{ github.event.repository.name }}
          
          llm:
            provider: openai
            model: gpt-4
            # api_key will be picked up from KATICH_LLM_API_KEY or OPENAI_API_KEY env var
          
          embeddings:
            provider: openai
            model: text-embedding-3-small
          
          review:
            generate_html: true
            html_output_path: .katich/reports
          EOF
          
          # Build context
          katich context build

      - name: Run Review on PR Diff
        run: |
          # Fetch feature branch
          git fetch origin ${{ github.event.pull_request.head.ref }}
          
          # Run review with environment variables
          katich review diff ${{ github.event.pull_request.base.ref }}..${{ github.event.pull_request.head.ref }} \
            --output markdown \
            --output-file review.md

      - name: Upload HTML Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katich-report-${{ github.event.pull_request.number }}
          path: .katich/reports/
          retention-days: 7

      - name: Post Review as PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('review.md', 'utf8');
            
            // Format the report for GitHub
            const formattedReport = `## ðŸ¤– Katich AI Code Review
            
**Review for PR #${context.issue.number}**
            
${report}
            
ðŸ“Š *HTML report available in workflow artifacts*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: formattedReport
            });
