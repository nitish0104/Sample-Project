name: Katich AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - master

jobs:
  katich-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout base branch with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
      
      - name: Fetch PR head branch
        run: |
          echo "ğŸ”„ Fetching PR branches..."
          git fetch origin ${{ github.event.pull_request.head.ref }}
          
          echo "ğŸ“Š Repository state:"
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head branch: ${{ github.event.pull_request.head.ref }}"
          echo ""
          echo "Available branches:"
          git branch -a | grep -E "${{ github.event.pull_request.base.ref }}|${{ github.event.pull_request.head.ref }}"
      
      - name: Download and Install Katich
        run: |
          echo "ğŸ“¥ Downloading Katich..."
          curl -L https://github.com/kodehash/katichai-dist/releases/latest/download/katich_linux_amd64.tar.gz -o katich.tar.gz
          tar -xzf katich.tar.gz
          chmod +x katich-linux-amd64
          sudo mv katich-linux-amd64 /usr/local/bin/katich
          
          echo "âœ… Katich installed:"
          katich version
      
      - name: Initialize Katich
        run: |
          echo "ğŸš€ Initializing Katich..."
          katich init
          echo "âœ… Katich configuration created"
          ls -la .katich/
      
      - name: Configure Katich
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          KATICH_LLM_API_KEY: ${{ secrets.KATICH_LLM_API_KEY }}
        run: |
          # Determine which API to use (priority order)
          if [ ! -z "$OPENAI_API_KEY" ]; then
            echo "ğŸ”‘ Configuring OpenAI provider..."
            API_PROVIDER="openai"
            API_KEY_TO_USE="$OPENAI_API_KEY"
            API_KEY_TO_TEST="$OPENAI_API_KEY"
          elif [ ! -z "$KATICH_LLM_API_KEY" ]; then
            echo "ğŸ”‘ Configuring OpenAI provider (from KATICH_LLM_API_KEY)..."
            API_PROVIDER="openai"
            API_KEY_TO_USE="$KATICH_LLM_API_KEY"
            API_KEY_TO_TEST="$KATICH_LLM_API_KEY"
          elif [ ! -z "$ANTHROPIC_API_KEY" ]; then
            echo "ğŸ”‘ Configuring Anthropic provider..."
            API_PROVIDER="anthropic"
            API_KEY_TO_USE="$ANTHROPIC_API_KEY"
            API_KEY_TO_TEST="$ANTHROPIC_API_KEY"
          else
            echo "::error::âŒ No API key found!"
            echo "Please set OPENAI_API_KEY or ANTHROPIC_API_KEY in repository secrets"
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          
          # Create optimized config based on provider
          if [ "$API_PROVIDER" = "openai" ]; then
            cat > .katich/config.yaml << EOF
          project_name: ${{ github.repository }}
          
          llm:
            provider: openai
            model: gpt-4o
            api_key: "$API_KEY_TO_USE"
            max_input_tokens: 100000
            max_tokens: 4000
          
          embeddings:
            provider: openai
            model: text-embedding-3-small
          
          review:
            generate_html: true
            html_output_path: .katich/reports
          
          analysis:
            max_function_length: 50
            complexity_threshold: 10
            similarity_threshold: 0.70
            min_function_lines: 5
            duplicate_threshold: 0.85
            ignore_trivial_patterns: true
            sampling:
              enabled: true
              max_files: 50
              context_lines: 2
              skip_generated: true
              skip_tests: false
              adaptive_budget: true
          EOF
            echo "âœ… OpenAI configured: gpt-4o (128K input, 4K output)"
          else
            cat > .katich/config.yaml << EOF
          project_name: ${{ github.repository }}
          
          llm:
            provider: anthropic
            model: claude-3-5-sonnet-20241022
            api_key: "$API_KEY_TO_USE"
            max_input_tokens: 150000
            max_tokens: 4000
          
          embeddings:
            provider: openai
            model: text-embedding-3-small
          
          review:
            generate_html: true
            html_output_path: .katich/reports
          
          analysis:
            max_function_length: 50
            complexity_threshold: 10
            similarity_threshold: 0.70
            min_function_lines: 5
            duplicate_threshold: 0.85
            ignore_trivial_patterns: true
            sampling:
              enabled: true
              max_files: 50
              context_lines: 2
              skip_generated: true
              skip_tests: false
              adaptive_budget: true
          EOF
            echo "âœ… Anthropic configured: claude-3-5-sonnet (200K context)"
          fi
          
          # Export for next step
          echo "API_PROVIDER=$API_PROVIDER" >> $GITHUB_ENV
          echo "API_KEY_TO_TEST=$API_KEY_TO_TEST" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ“‹ Configuration preview:"
          grep -E "provider:|model:|max_tokens:" .katich/config.yaml
      
      - name: Verify API Key
        env:
          API_PROVIDER: ${{ env.API_PROVIDER }}
          API_KEY_TO_TEST: ${{ env.API_KEY_TO_TEST }}
        run: |
          echo "ğŸ” Testing API key connectivity..."
          
          if [ "$API_PROVIDER" = "openai" ]; then
            echo "Testing OpenAI API key..."
            
            # Test OpenAI API
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
              https://api.openai.com/v1/models \
              -H "Authorization: Bearer $API_KEY_TO_TEST" \
              -H "Content-Type: application/json")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… OpenAI API key is valid and working!"
              echo "ğŸ“Š Available models:"
              cat response.json | grep -o '"id":"[^"]*"' | head -5 | sed 's/"id":"\([^"]*\)"/  - \1/'
            elif [ "$HTTP_CODE" = "401" ]; then
              echo "::error::âŒ OpenAI API key is INVALID!"
              echo "The API key authentication failed."
              echo "Please check:"
              echo "  1. The API key is correct (should start with 'sk-')"
              echo "  2. The key hasn't been revoked"
              echo "  3. Copy-paste the key carefully without extra spaces"
              cat response.json
              exit 1
            elif [ "$HTTP_CODE" = "429" ]; then
              echo "::warning::âš ï¸ Rate limit reached or quota exceeded"
              echo "Please check your OpenAI account:"
              echo "  1. Visit: https://platform.openai.com/usage"
              echo "  2. Ensure you have credits available"
              echo "  3. Check if you've hit rate limits"
              cat response.json
              exit 1
            else
              echo "::warning::âš ï¸ Unexpected response from OpenAI API (HTTP $HTTP_CODE)"
              echo "Response:"
              cat response.json
              echo ""
              echo "Continuing anyway, but review may fail..."
            fi
            
          elif [ "$API_PROVIDER" = "anthropic" ]; then
            echo "Testing Anthropic API key..."
            
            # Test Anthropic API
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
              https://api.anthropic.com/v1/messages \
              -H "x-api-key: $API_KEY_TO_TEST" \
              -H "anthropic-version: 2023-06-01" \
              -H "content-type: application/json" \
              -d '{
                "model": "claude-3-5-sonnet-20241022",
                "max_tokens": 10,
                "messages": [{"role": "user", "content": "test"}]
              }')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Anthropic API key is valid and working!"
            elif [ "$HTTP_CODE" = "401" ]; then
              echo "::error::âŒ Anthropic API key is INVALID!"
              echo "The API key authentication failed."
              echo "Please check your API key at: https://console.anthropic.com/"
              cat response.json
              exit 1
            elif [ "$HTTP_CODE" = "429" ]; then
              echo "::warning::âš ï¸ Rate limit reached"
              echo "Please check your Anthropic account usage"
              cat response.json
              exit 1
            else
              echo "::warning::âš ï¸ Unexpected response from Anthropic API (HTTP $HTTP_CODE)"
              cat response.json
              echo ""
              echo "Continuing anyway, but review may fail..."
            fi
          fi
          
          # Clean up
          rm -f response.json
          
          echo ""
          echo "âœ… API key verification complete!"
      
      - name: Build Context (Optional)
        continue-on-error: true
        run: |
          echo "ğŸ” Building context for better review quality..."
          # Add timeout to prevent hanging
          timeout 300 katich context build || {
            echo "âš ï¸ Context build timed out or failed - continuing without context"
            echo "This is not critical, reviews will still work"
          }
      
      - name: Verify Git Diff
        id: verify-diff
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="origin/${{ github.event.pull_request.head.ref }}"
          
          echo "ğŸ“Š Checking for changes between branches..."
          echo "Comparing: $BASE_BRANCH..$HEAD_BRANCH"
          
          # Verify both branches exist
          if ! git rev-parse "$BASE_BRANCH" >/dev/null 2>&1; then
            echo "::error::Base branch not found: $BASE_BRANCH"
            exit 1
          fi
          
          if ! git rev-parse "$HEAD_BRANCH" >/dev/null 2>&1; then
            echo "::error::Head branch not found: $HEAD_BRANCH"
            exit 1
          fi
          
          # Count changes
          CHANGED_FILES=$(git diff --name-only "$BASE_BRANCH".."$HEAD_BRANCH" | wc -l)
          echo "changes=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          echo "âœ… Found $CHANGED_FILES changed file(s)"
          
          if [ "$CHANGED_FILES" -eq 0 ]; then
            echo "::warning::No file changes detected between branches"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ“ Changed files (first 10):"
            git diff --name-only "$BASE_BRANCH".."$HEAD_BRANCH" | head -10
          fi
      
      - name: Run Katich Review
        if: steps.verify-diff.outputs.has_changes == 'true'
        id: run-review
        continue-on-error: true
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="origin/${{ github.event.pull_request.head.ref }}"
          
          echo "ğŸ¤– Starting Katich AI Review..."
          echo "ğŸ“Š Review range: $BASE_BRANCH..$HEAD_BRANCH"
          echo ""
          
          # Run review and capture all output
          set +e  # Don't exit on error
          katich review diff "$BASE_BRANCH".."$HEAD_BRANCH" 2>&1 | tee review_output.txt
          REVIEW_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          echo ""
          echo "review_exit_code=$REVIEW_EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $REVIEW_EXIT_CODE -eq 0 ]; then
            echo "âœ… Review completed successfully"
          else
            echo "âš ï¸ Review exited with code: $REVIEW_EXIT_CODE"
            
            # Check for specific error patterns
            if grep -qi "api key\|authentication\|unauthorized" review_output.txt; then
              echo "::error::API authentication failed. Please check your API key and credits."
            elif grep -qi "timeout\|timed out" review_output.txt; then
              echo "::error::Request timed out. The API provider may be slow or unavailable."
            elif grep -qi "rate limit" review_output.txt; then
              echo "::error::Rate limit exceeded. Please wait and try again."
            elif grep -qi "no changes\|no files" review_output.txt; then
              echo "::warning::No reviewable changes found."
            else
              echo "::error::Review failed. Check the output above for details."
            fi
          fi
          
          # Check if reports were generated
          if [ -d ".katich/reports" ] && [ "$(ls -A .katich/reports 2>/dev/null)" ]; then
            echo "âœ… HTML reports generated:"
            ls -lh .katich/reports/
            echo "has_reports=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No HTML reports generated"
            echo "has_reports=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Handle No Changes
        if: steps.verify-diff.outputs.has_changes == 'false'
        run: |
          cat > review_output.txt << 'EOF'
          ## â„¹ï¸ No Changes to Review
          
          No file changes were detected between the base and head branches.
          This PR may only contain merge commits or identical content.
          EOF
          
          echo "â„¹ï¸ No changes to review - skipping analysis"
      
      - name: Move Reports to Comments Directory
        if: steps.run-review.outputs.has_reports == 'true'
        run: |
          mkdir -p comments
          mv .katich/reports/* comments/ 2>/dev/null || true
          echo "âœ… Reports moved to comments directory"
          ls -la comments/
      
      - name: Generate PR Comment
        if: always()
        run: |
          if [ "${{ steps.verify-diff.outputs.has_changes }}" = "false" ]; then
            # No changes case
            cat > pr_comment.md << 'EOF'
          ## ğŸ¤– Katich AI Code Review
          
          ### â„¹ï¸ No Changes Detected
          
          No file changes were found between the base and head branches.
          This may occur if:
          - The PR only contains merge commits
          - The branches have identical content
          - All changes are in ignored files
          
          ---
          *Generated by [Katich AI](https://github.com/kodehash/katichai-dist)*
          EOF
          
          elif [ "${{ steps.run-review.outputs.review_exit_code }}" = "0" ]; then
            # Success case - Parse and format the review output
            cat > pr_comment.md << 'EOF'
          ## ğŸ¤– Katich AI Code Review Report
          
          EOF
            
            # Extract key information from review output
            if [ -f "review_output.txt" ]; then
              # Extract Summary
              if grep -q "ğŸ“Œ SUMMARY" review_output.txt; then
                echo "### ğŸ“Œ Summary" >> pr_comment.md
                echo "" >> pr_comment.md
                sed -n '/ğŸ“Œ SUMMARY/,/^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„/p' review_output.txt | \
                  grep -v "ğŸ“Œ SUMMARY" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„" | \
                  sed 's/^//' >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Token Usage
              if grep -q "ğŸ“Š Tokens:" review_output.txt; then
                TOKENS=$(grep "ğŸ“Š Tokens:" review_output.txt | head -1)
                echo "<details>" >> pr_comment.md
                echo "<summary>ğŸ“Š Token Usage</summary>" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "$TOKENS" | sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "</details>" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Critical Issues
              if grep -q "âš ï¸  CRITICAL ISSUES\|âš ï¸ CRITICAL ISSUES" review_output.txt; then
                echo "### âš ï¸ Critical Issues" >> pr_comment.md
                echo "" >> pr_comment.md
                sed -n '/âš ï¸.*CRITICAL ISSUES/,/^ğŸ’¡\|^âœ…\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„/p' review_output.txt | \
                  grep -v "âš ï¸.*CRITICAL ISSUES" | \
                  grep -v "^ğŸ’¡\|^âœ…\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„" | \
                  sed 's/^//' >> pr_comment.md
                echo "" >> pr_comment.md
              elif grep -q "âœ… No critical issues found" review_output.txt; then
                echo "### âœ… Critical Issues" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "No critical issues found! ğŸ‰" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Suggestions
              if grep -q "ğŸ’¡ SUGGESTIONS" review_output.txt; then
                echo "### ğŸ’¡ Suggestions" >> pr_comment.md
                echo "" >> pr_comment.md
                sed -n '/ğŸ’¡ SUGGESTIONS/,/^âš ï¸\|^âœ…\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„/p' review_output.txt | \
                  grep -v "ğŸ’¡ SUGGESTIONS" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„" | \
                  sed 's/^//' >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Duplicate Code section
              if grep -q "ğŸ”„ DUPLICATE CODE" review_output.txt; then
                echo "<details>" >> pr_comment.md
                echo "<summary>ğŸ”„ Duplicate Code Analysis</summary>" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                sed -n '/ğŸ”„ DUPLICATE CODE/,/^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§/p' review_output.txt | \
                  grep -v "ğŸ”„ DUPLICATE CODE" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§" | \
                  sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "</details>" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Static Analysis section
              if grep -q "ğŸ“Š STATIC ANALYSIS" review_output.txt; then
                echo "<details>" >> pr_comment.md
                echo "<summary>ğŸ“Š Static Analysis</summary>" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                sed -n '/ğŸ“Š STATIC ANALYSIS/,/^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ”§\|^ğŸ”„/p' review_output.txt | \
                  grep -v "ğŸ“Š STATIC ANALYSIS" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ”§\|^ğŸ”„" | \
                  sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "</details>" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract AI-Generated Code Analysis
              if grep -q "ğŸ¤– AI-GENERATED CODE ANALYSIS" review_output.txt; then
                echo "<details>" >> pr_comment.md
                echo "<summary>ğŸ¤– AI-Generated Code Analysis</summary>" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                sed -n '/ğŸ¤– AI-GENERATED CODE ANALYSIS/,/^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„/p' review_output.txt | \
                  grep -v "ğŸ¤– AI-GENERATED CODE ANALYSIS" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”§\|^ğŸ”„" | \
                  sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "</details>" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
              
              # Extract Unnecessary Complexity
              if grep -q "ğŸ”§ UNNECESSARY COMPLEXITY" review_output.txt; then
                echo "<details>" >> pr_comment.md
                echo "<summary>ğŸ”§ Unnecessary Complexity</summary>" >> pr_comment.md
                echo "" >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                sed -n '/ğŸ”§ UNNECESSARY COMPLEXITY/,/^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”„/p' review_output.txt | \
                  grep -v "ğŸ”§ UNNECESSARY COMPLEXITY" | \
                  grep -v "^âš ï¸\|^âœ…\|^ğŸ’¡\|^ğŸ“Š\|^ğŸ”„" | \
                  sed 's/\x1b\[[0-9;]*m//g' >> pr_comment.md
                echo "\`\`\`" >> pr_comment.md
                echo "</details>" >> pr_comment.md
                echo "" >> pr_comment.md
              fi
            fi
            
            # Add link to HTML report
            cat >> pr_comment.md << 'EOF'
          
          ---
          
          ### ğŸ“¦ Detailed HTML Report
          
          ğŸ“„ A comprehensive HTML report with interactive features is available in the workflow artifacts:
          
          1. Go to the [**Actions tab**](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. Scroll down to **Artifacts** section
          3. Download **katich-review-report-${{ github.event.pull_request.number }}**
          4. Extract and open the HTML file in your browser
          
          The HTML report includes:
          - ğŸ¨ Interactive dashboard with metrics
          - ğŸ“Š Detailed code analysis with syntax highlighting
          - ğŸ”„ Side-by-side duplicate code comparisons
          - ğŸ“ˆ Complexity visualizations
          - ğŸ” Function-level breakdown
          
          ---
          
          <details>
          <summary>â„¹ï¸ Review Information</summary>
          
          - **Model**: GPT-4o
          - **Base Branch**: ${{ github.event.pull_request.base.ref }}
          - **Head Branch**: ${{ github.event.pull_request.head.ref }}
          - **Files Reviewed**: ${{ steps.verify-diff.outputs.changes }}
          - **Commit**: `${{ github.sha }}`
          
          </details>
          
          *Generated by [Katich AI](https://github.com/kodehash/katichai-dist) â€¢ [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
          
          else
            # Failure case
            cat > pr_comment.md << 'EOF'
          ## âš ï¸ Katich AI Code Review - Error
          
          The code review encountered an error and could not complete successfully.
          
          ### Common Issues and Solutions:
          
          1. **API Key Problems**
             - Verify your API key is correct in repository secrets
             - Check that your API account has sufficient credits
             - Ensure the key has not expired
          
          2. **Network Issues**
             - The API provider may be experiencing downtime
             - Rate limits may have been exceeded
          
          3. **Configuration Issues**
             - Check that branches exist and are accessible
             - Verify repository permissions
          
          ### Next Steps:
          - Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error messages
          - Try re-running the workflow
          - Test locally: `katich review diff ${{ github.event.pull_request.base.ref }}..origin/${{ github.event.pull_request.head.ref }}`
          
          ---
          
          *Generated by [Katich AI](https://github.com/kodehash/katichai-dist)*
          EOF
          fi
          
          echo "âœ… PR comment generated"
      
      - name: Post Review as PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('pr_comment.md', 'utf8');
            
            try {
              // Find existing Katich comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const katichComment = comments.find(comment => 
                comment.body.includes('ğŸ¤– Katich AI Code Review')
              );
              
              if (katichComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: katichComment.id,
                  body: commentBody
                });
                console.log('âœ… Updated existing Katich comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('âœ… Posted new Katich comment');
              }
            } catch (error) {
              console.error('âŒ Failed to post comment:', error.message);
              core.setFailed('Failed to post PR comment');
            }
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katich-review-report-${{ github.event.pull_request.number }}
          path: |
            comments/*.html
            review_output.txt
            pr_comment.md
            .katich/config.yaml
          retention-days: 30
          if-no-files-found: warn
      
      - name: Check for Critical Issues
        if: steps.run-review.outputs.review_exit_code == '0'
        run: |
          if [ -f "review_output.txt" ]; then
            # Look for security issues
            if grep -q "ğŸ”´.*\[SECURITY\]" review_output.txt; then
              echo "::warning::âš ï¸ Critical security issues found! Please review before merging."
            fi
            
            # Count critical issues
            CRITICAL_COUNT=$(grep -c "ğŸ”´" review_output.txt || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::notice::Found $CRITICAL_COUNT critical issue(s) - please review"
            fi
          fi
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "## ğŸ¯ Katich AI Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify-diff.outputs.has_changes }}" = "false" ]; then
            echo "### â„¹ï¸ No Changes to Review" >> $GITHUB_STEP_SUMMARY
            echo "No file changes detected between branches." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.run-review.outputs.review_exit_code }}" = "0" ]; then
            echo "### âœ… Review Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Changed Files**: ${{ steps.verify-diff.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Reports Generated**: ${{ steps.run-review.outputs.has_reports == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Comment**: Posted" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Review Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Exit code: ${{ steps.run-review.outputs.review_exit_code }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs and PR comment for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Branch**: ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Head Branch**: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
